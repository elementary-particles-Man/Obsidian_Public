# VoV Protocol Specification

## 📌 Overview
VoV（Void on Voice）は、匿名・分散型通信基盤であり、動的に通信モデルを選択し、発信者・受信者の環境に最適化されたルートで通信を成立させます。本仕様書は、VoVの通信プロトコル階層と構造、およびデータ転送ルールを定義します。

---

## 🔹 Protocol Layer Structure

```
+------------------------------+
| User Layer                  |
|  - UI, Input, Message View  |
+------------------------------+
| Profiler Layer              |
|  - NAT判定, 帯域測定         |
+------------------------------+
| Model Selection Layer       |
|  - CommModel選択             |
+------------------------------+
| Communication Layer         |
|  - Low/Balanced/High Load   |
+------------------------------+
| VoV VC Layer (Core)         |
|  - NodeID解決, 中継,優先制御 |
+------------------------------+
| Storage Layer               |
|  - 分散格納, 復元処理        |
+------------------------------+
```

---

## 🔸 NodeID & Identity
- **NodeID**: `SHA256(PublicKey)` により決定。IDは変更不可。
- **KeyPair**: ECDSA (secp256k1) による公開鍵暗号
- **Routing**: NodeIDベースでDHTを用いたルーティングを行う

---

## 🔸 Comm Model Selection Protocol

### Input (from Profiler)
```json
{
  "natType": "symmetric",
  "bandwidthUp": 0.5,
  "latencyMs": 120,
  "isMobile": true
}
```

### Logic
| 条件 | モデル選択 |
|------|-------------|
| NATがSymmetric またはモバイル | Low Load Model |
| 上り帯域 > 5Mbps、安定 | High Load Model |
| それ以外 | Balanced Model |

---

## 🔸 Communication Models

### Low Load Model
- **Transport**: HTTP Long Poll, MQTT
- **Encryption**: TLS 1.3 + VoV暗号化（AES-CTR + Node署名）
- **Reliability**: 中継必須、再送制御あり

### Balanced Model
- **Transport**: UDP Gossip + DHT Lookup
- **Message**: `MSG_ID + TTL + PAYLOAD`
- **Gossip制御**: 重複除去、TTL削減、送信制限

### High Load Model
- **Transport**: libp2p Direct + Relay Mesh
- **Routing**: AutoNAT + Kademlia
- **常時接続**: Direct Channel維持、Ping/Pong維持

---

## 🔸 VoV VC Layer（Core Protocol）

### NodeID Registry
- `PUT`: NodeID → IP + Port + Capability
- `GET`: NodeID → 現在の到達可能経路
- TTL更新＋署名付き更新（改ざん防止）

### Relay Mesh
- マルチRelay登録方式、最短3つ以上保持推奨
- 中継経路はラウンドロビン or RTT優先

### Address Virtualization
- IP非公開、NodeID指定で通信要求
- 初期はRelay、成功後Directに切替

### Prioritizer
- `storageScore` により優先度付加
- メッセージ毎にQoSクラスを動的計算

---

## 🔸 Storage Protocol

### 格納形式（断片）
```json
{
  "fragmentID": "uuid",
  "nodeID": "...",
  "contentHash": "sha256",
  "payload": "...base64...",
  "expires": 1680000000
}
```

### 分散冗長方式
- XORベースErasure Coding
- 最低N片中K片で復元可

### 復元時
- 取得失敗: RelayMesh経由で再要求
- 不正断片: 署名不一致による破棄

---

## 🔚 Security Notes
- すべての通信はNode署名付き暗号パケット
- Metadata leakage最小化
- 中継ノードも含め、IP/Node分離されたログ管理

---

本仕様は初版であり、実装フィードバックに応じて拡張可能です。
